<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Yay!</title>
   <script src="./fuzzySearch.js"></script>
   <style>
      .highlight {
         background-color: pink;
      }
   </style>
</head>
<body>
   <form autocomplete="off">
      <label for="search">Search for something totally awesome!</label>
      <input data-list="search-list" data-limit="3" name="search" autocomplete="off" placeholder="Search for something!">
      <div id="search-list"></div>
      <input type="text" value="I love pizza">
   </form>

   <script>
      var list =
         [ { value: "Chocolate", id: 1 }
         , { value: "Coconut", id: 2 }
         , { value: "Mint", id: 3 }
         , { value: "Strawberry", id: 4 }
         , { value: "Vanilla", id: 5 } ]
      var searchList = list.map(x => ({ compareValue: x.value.toLowerCase(), value: x.value, id: x.id }))
      const createLI = ({ value, id }) => {
         const li = document.createElement("li")
         li.innerText = value
         li.dataset.id = id
         return li
      }
      const createULList = (list, options) => {
         var ul = document.createElement("ul")
         list.some((data, index) => {
            if (data.similarity === 0) return true
            ul.append(createLI(data))
            return index === options.limit
         })
         var appendTo = options.appendTo
         appendTo.innerHTML = ""
         appendTo.append(ul)
      }

      var form = document.forms[0]
      var options = form.search.dataset
      var searchListId = options.list // Or error
      const $searchList = document.getElementById(searchListId)
      var limit = +(options.limit || 5) - 1
      var ulOptions = { limit, appendTo: $searchList }

      const tab = "Tab"
         , arrowUp = "ArrowUp"
         , arrowDown = "ArrowDown"
         , enter = "Enter"
         , shift = "Shift"
         , escape = "Escape"
      const key = { tab, arrowUp, arrowDown, enter, shift, escape }
      const commandKeys = [ tab, arrowUp, arrowDown, enter ]

      form.search.addEventListener("keydown", e => {
         if (commandKeys.some(x => e.key === x)) {
            if (!e.shiftKey && [key.tab, key.arrowDown].some(x => x === e.key)) {
               if (!ulOptions.appendTo.innerHTML.trim()) {
                  form.search.dispatchEvent(new KeyboardEvent("keydown", { key: key.escape }))
                  return
               }
               var currentChosen = ulOptions.appendTo.querySelector("li.highlight")
               var nextChosen
               if (currentChosen) {
                  currentChosen.classList.remove("highlight")
                  nextChosen = currentChosen.nextSibling || ulOptions.appendTo.querySelector("li:first-child")
               } else {
                  nextChosen = ulOptions.appendTo.querySelector("li:first-child")
               }
               if (nextChosen) {
                  nextChosen.classList.add("highlight")
               }
            }
            if (e.key === key.arrowUp || (e.shiftKey && e.key === key.tab)) {
               var currentChosen = ulOptions.appendTo.querySelector("li.highlight")
               var nextChosen
               if (currentChosen) {
                  currentChosen.classList.remove("highlight")
                  nextChosen = currentChosen.previousSibling || ulOptions.appendTo.querySelector("li:last-child")
               } else {
                  nextChosen = ulOptions.appendTo.querySelector("li:last-child")
               }
               if (nextChosen) {
                  nextChosen.classList.add("highlight")
               }
            }
            if (e.key === key.enter) {
               var currentChosen = ulOptions.appendTo.querySelector("li.highlight")
               if (currentChosen) {
                  var id = currentChosen.dataset.id
                  form.search.value = currentChosen.textContent
                  form.search.dataset.id = id
                  ulOptions.appendTo.innerHTML = ""
               }
            }
            e.preventDefault()
            return false
         }
      })

      form.search.addEventListener("blur", e => {
         ulOptions.appendTo.innerHTML = ""
      })

      form.search.addEventListener("focus", e => {
         const search = e.target
         if (search.value.length > 0) {
            search.select()
            search.dispatchEvent(new KeyboardEvent("keyup"))
         }
      })

      form.search.addEventListener("keyup", e => {
         if (commandKeys.some(x => e.key === x) || e.key === key.shift) {
            return
         }
         const value = e.target.value.toLowerCase()
         var fuzzy = searchList.map(x => ({ ...fuzzySearch(value, x.compareValue), value: x.value, id: x.id }))
         fuzzy.sort((a, b) => a.similarity > b.similarity ? -1 : 1)
         createULList(fuzzy, ulOptions)
      })
   </script>

</body>
</html>